<%- include('../templates/header'); -%>

<div class="container-fluid">
	<h1 class="mt-5" style="text-align: center">Results</h1>
	<div
		class="d-flex flex-row flex-wrap align-items-center justify-content-center"
	>
		<div class="col-lg-12 col-xl-4 col-md-12 col-sm-12 col-12 bar-chart">
			<canvas id="voteFemale"></canvas>
		</div>
		<div class="col-lg-12 col-xl-4 col-md-12 col-sm-12 col-12 bar-chart">
			<canvas id="voteMale"></canvas>
		</div>
		<div class="col-lg-12 col-xl-4 col-md-12 col-sm-12 col-12 bar-chart">
			<canvas id="voteGroup"></canvas>
		</div>
	</div>
	<div>
		<button
			type="button"
			class="btn btn-danger btn-lg btn-block"
			id="disable-vote"
		>
			Disable Votes
		</button>
		<button
			type="button"
			class="btn btn-warning btn-lg btn-block"
			id="disable-result"
		>
			Disable Results
		</button>
		<button
			type="button"
			class="btn btn-secondary btn-lg btn-block mb-3"
			id="enable-final-result"
		>
			Display Final Results
		</button>
	</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
	// Initialize the canvas
	const maleCtx = document.getElementById('voteMale').getContext('2d');
	const femaleCtx = document.getElementById('voteFemale').getContext('2d');
	const groupCtx = document.getElementById('voteGroup').getContext('2d');

	const options = {
		maintainAspectRatio: false,
		scales: {
			yAxes: [
				{
					gridLines: {
						display: false,
					},
					ticks: { precision: 0, fontSize: 16 },
				},
			],
			xAxes: [
				{
					ticks: { fontSize: 16 },
				},
			],
		},
	};

	// Initialize the chart
	const femaleChart = new Chart(femaleCtx, {
		type: 'bar',
		data: {
			labels: ['Female'],
		},
		options: options,
	});

	const maleChart = new Chart(maleCtx, {
		type: 'bar',
		data: {
			labels: ['Male'],
		},
		options: options,
	});

	const groupChart = new Chart(groupCtx, {
		type: 'bar',
		data: {
			labels: ['Family'],
		},
		options: options,
	});

	const socket = io();

	function randomRGB() {
		const r = () => (Math.random() * 256) >> 0;
		return `rgb(${r()}, ${r()}, ${r()})`;
	}

	// On new vote update the chart
	socket.on('update', (candidates) => {
		let femaleUser = candidates.filter(
			(candidate) =>
				candidate.User === 'FirstFemale' ||
				candidate.User === 'SecondFemale' ||
				candidate.User === 'ThirdFemale'
		);
		let maleUser = candidates.filter(
			(candidate) =>
				candidate.User === 'FirstMale' ||
				candidate.User === 'SecondMale' ||
				candidate.User === 'ThirdMale'
		);
		let groupUser = candidates.filter(
			(candidate) =>
				candidate.User === 'FirstGroup' ||
				candidate.User === 'SecondGroup' ||
				candidate.User === 'ThirdGroup'
		);

		femaleUser = Object.entries(femaleUser);
		maleUser = Object.entries(maleUser);
		groupUser = Object.entries(groupUser);

		for (const [key, candidate] of femaleUser) {
			// Update the vote if the candidate already exists if not create a new candidate and then update the vote

			let contestantName;
			if (candidate.User === 'FirstFemale') contestantName = 'Female A';
			if (candidate.User === 'SecondFemale') contestantName = 'Female B';
			if (candidate.User === 'ThirdFemale') contestantName = 'Female C';

			if (
				typeof femaleChart.data.datasets[key] == 'undefined' &&
				femaleChart.data.datasets.length < candidates.length
			) {
				femaleChart.data.datasets.push({
					backgroundColor: randomRGB(),
					borderColor: randomRGB(),
					data: [candidate.Vote],
					label: contestantName,
				});
			} else if (typeof femaleChart.data.datasets[key] != 'undefined') {
				femaleChart.data.datasets[key].data = [candidate.Vote];
			}
		}

		// For each candidate
		for (const [key, candidate] of maleUser) {
			// Update the vote if the candidate already exists if not create a new candidate and then update the vote

			let contestantName;
			if (candidate.User === 'FirstMale') contestantName = 'Male A';
			if (candidate.User === 'SecondMale') contestantName = 'Male B';
			if (candidate.User === 'ThirdMale') contestantName = 'Male C';

			if (
				typeof maleChart.data.datasets[key] == 'undefined' &&
				maleChart.data.datasets.length < candidates.length
			) {
				maleChart.data.datasets.push({
					backgroundColor: randomRGB(),
					borderColor: randomRGB(),
					data: [candidate.Vote],
					label: contestantName,
				});
			} else if (typeof maleChart.data.datasets[key] != 'undefined') {
				maleChart.data.datasets[key].data = [candidate.Vote];
			}
		}

		for (const [key, candidate] of groupUser) {
			// Update the vote if the candidate already exists if not create a new candidate and then update the vote

			let contestantName;
			if (candidate.User === 'FirstGroup') contestantName = 'Family A';
			if (candidate.User === 'SecondGroup') contestantName = 'Family B';
			if (candidate.User === 'ThirdGroup') contestantName = 'Family C';

			if (
				typeof groupChart.data.datasets[key] == 'undefined' &&
				groupChart.data.datasets.length < candidates.length
			) {
				groupChart.data.datasets.push({
					backgroundColor: randomRGB(),
					borderColor: randomRGB(),
					data: [candidate.Vote],
					label: contestantName,
				});
			} else if (typeof groupChart.data.datasets[key] != 'undefined') {
				groupChart.data.datasets[key].data = [candidate.Vote];
			}
		}

		// Update the chart
		femaleChart.update();
		maleChart.update();
		groupChart.update();
	});
</script>

<script>
	const disableResultBtn = document.getElementById('disable-result');
	const disableVoteBtn = document.getElementById('disable-vote');
	const enableFinalResultBtn = document.getElementById('enable-final-result');

	disableResultBtn.addEventListener('click', async (_) => {
		try {
			const response = await fetch('/disableResult', {
				method: 'post',
			});
			console.log('Completed!', response);
		} catch (err) {
			console.error(`Error: ${err}`);
		}
	});

	disableVoteBtn.addEventListener('click', async (_) => {
		try {
			const response = await fetch('/disableVote', {
				method: 'post',
			});
			console.log('Completed!', response);
		} catch (err) {
			console.error(`Error: ${err}`);
		}
	});

	enableFinalResultBtn.addEventListener('click', async (_) => {
		try {
			const response = await fetch('/enableFinalResult', {
				method: 'post',
			});
			console.log('Completed!', response);
		} catch (err) {
			console.error(`Error: ${err}`);
		}
	});
</script>

<%- include('../templates/footer'); -%>
